# Теория и терминология.

## Немного теории.

Что такое атрибуты и чем они отличаются от опций, Вы можете прочитать в интернете. Информации достаточно, например, [здесь](http://docs.myopencart.com/index.php?title=%D0%90%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%82%D1%8B)
                    или [здесь](http://bono-idea.com/blog/instrukciya-po-rabote-s-opciyami-i-atributami-v-OpenCart-2/). Если коротко, то это характеристики, которые позволяют
                    систематизировать товары, сравнивать товары, делать поиск или выборки с помощью фильтров.

В OpenCart принята следующая структура атрибутов:

```

&#x413;&#x440;&#x443;&#x43F;&#x43F;&#x430; &#x430;&#x442;&#x440;&#x438;&#x431;&#x443;&#x442;&#x43E;&#x432;
&#x2514;&#x2500;&#x2500; &#x410;&#x442;&#x440;&#x438;&#x431;&#x443;&#x442;

```

Значение атрибута относится к конкретному товару:

```

&#x422;&#x43E;&#x432;&#x430;&#x440;
&#x251C;&#x2500;&#x2500; &#x421;&#x441;&#x44B;&#x43B;&#x43A;&#x430; &#x43D;&#x430; &#x430;&#x442;&#x440;&#x438;&#x431;&#x443;&#x442;
&#x2514;&#x2500;&#x2500; &#x417;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x435; &#x430;&#x442;&#x440;&#x438;&#x431;&#x443;&#x442;&#x430;

```

Так вот, все, перечисленные выше, задачи выполняются анализируя именно значения атрибутов. Т.е. если Вы добавите атрибут в товар, но не впишите его значение,
                    то анализировать будет нечего.

Любой товар может иметь несколько атрибутов. Любой атрибут может иметь несколько значений. Значение атрибута это, на самом деле, текстовое поле, куда через разделитель
                    можно вписать несколько значений.

Модуль Attribut&co (визуально) приводит структуру атрибутов и значений к удобному виду и представляет эту структуру в виде дерева.

```

&#x413;&#x440;&#x443;&#x43F;&#x43F;&#x430; &#x430;&#x442;&#x440;&#x438;&#x431;&#x443;&#x442;&#x43E;&#x432;
&#x2514;&#x2500;&#x2500; &#x410;&#x442;&#x440;&#x438;&#x431;&#x443;&#x442;
&#x2514;&#x2500;&#x2500; &#x417;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x435;(&#x441;&#x43F;&#x438;&#x441;&#x43E;&#x43A; &#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x439;) &#x430;&#x442;&#x440;&#x438;&#x431;&#x443;&#x442;&#x430;

```

Понятие <mark><small>Группа атрибутов</small></mark> используется только для систематизации самих атрибутов. Товары же систематизируются по категориям. Поэтому, кажется
                    логичным, сделать привязку определенного списка атрибутов с их значениями к определенной категории. Идея эта не нова и используется многими модулями, но именно эта идея
                    лежит в основе работы данного модуля.

```

&#x41A;&#x430;&#x442;&#x435;&#x433;&#x43E;&#x440;&#x438;&#x44F; &#x442;&#x43E;&#x432;&#x430;&#x440;&#x43E;&#x432;
&#x2514;&#x2500;&#x2500; &#x410;&#x442;&#x440;&#x438;&#x431;&#x443;&#x442;
&#x2514;&#x2500;&#x2500; &#x417;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x435;(&#x441;&#x43F;&#x438;&#x441;&#x43E;&#x43A; &#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x439;) &#x430;&#x442;&#x440;&#x438;&#x431;&#x443;&#x442;&#x430;

```

## Термины и определения.

|  Термин |  Описание |
| --- | --- |
|  Разделитель атрибутов |  Точнее было бы названиеРазделитель значений атрибутов. Повторимся, что у товара может быть несколько атрибутов и несколько значений
                                    атрибутов. Значение записывается в поле типа `TEXT` в Базе Данных. Чтобы отделить одно значение от другого используется разделитель. Как правило это `"/"` или `":"` или `";"` Современные фильтры, например filterpro, умеют разбирать такие конструкции. |
|  Группа |  ГруппаАтрибутов используется для систематизации самихАтрибутов. |
|  Атрибут |  СобственноАтрибут или характеристика товара. |
|  Атрибут категории | Атрибут, поставленный в соответствие какой-либо категории.Атрибут может быть поставлен в сотответствие
                                    нескольким категориям. Категория может иметь сопоставление с несколькимиАтрибутами. Т.е. когда мы говоримАтрибуты категории, то
                                    имеем ввиду списокАтрибутов, сопоставленных ("принадлежащих") категории. |
|  Шаблон |  НаборЗначенийАтрибута через разделитель. Т.е. запись типа `&#x417;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x435;1/&#x417;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x435;2/&#x417;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x438;&#x435;3` |
|
|  Значение |  Одиночное значениеАтрибута, выделенное изШаблона. ЧастоШаблон состоит из единственногоЗначения |
|  Дежурный шаблон |  Иначе можно назвать - шаблон по умолчанию. ЭтоШаблон, который хранится "вместе" сАтрибутом, содержит часто используемый наборЗначений и может быть автоматически "присвоен" товару в соответствии со[<mark><small>способом</small></mark>](settings.html#settings-product), заданным в настройках. |

#### Обозначение деревьев.

| № |  Вкладка |  Название |  Описание |
| --- | --- | --- | --- |
| 1 |  Атрибуты |  Группы атрибутов |  Основное дерево, где можно производить все манипуляции сГруппами,Атрибутами иЗначениями- редактирование, сортировку,
                                    поиск,
                                    удаление, добавление. |
| 2 |  Дежурные шаблоны |  Дежурные шаблоны |  Дерево для работы с[Дежурными шаблонами](#theory-duty). Редактирование, поиск. |
| 3 |  Атрибуты категорий |  Категории |  Структура категорий, показанная в виде дерева. |
| 4 |  Атрибуты категорий |  Атрибуты |  Дерево, аналогичноеГруппы атрибутов, служит для перетаскивания из него выбранного атрибута в нужную категорию с помощью технологии Drag-and-Drop либо копирования с помощью
                                    Copy-Paste. Желательно в структуру включать дочерниеДежурные шаблоны, чтобы напомнить, при добавленииАтрибута в категорию, какиеЗначения добавятся в товар. |
| 5 |  Атрибуты категорий |  Атрибуты категорий |  Дерево, которое показывает категорию со всеми приписанными ейАтрибутами и ихШаблонами иЗначениями. Здесь возможно добавить или удалить атрибуты. |
| 6 |  Товары |  Атрибуты товаров |  Дерево, аналогичноеГруппы атрибутов, служит для выбораАтрибута,Шаблона илиЗначения и фильтрации товаров по
                                    выбранному. |
| 7 |  Товары |  Товары |  Дерево, где отображаются товары для выбранногоАтрибута,Шаблона илиЗначения. Справа от наименования товара, в скобках
                                    выводится id товара
                                    в БД и модель. Двойной клик по выбранному товару переадресует на карточку товара. |
|  |  Любая |  Узел | Узел это по сути элемент дерева. Любое дерево состоит изУзлов.Узлы отображаются в виде папок либо других значков. Могут
                                    иметь текстовое название,
                                    могут быть
                                    пустыми. |

## Шаблоны и значения.

Чтобы лучше понимать, что такое Значение, стоит напомнить, что это обычный текст, описывающий характеристику (Атрибут)
                    товара. Значение записывается в поле типа `TEXT` в Базе Данных. Записать туда можно все, что угодно, например :
                    `"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua..."`.

Конечно, мы в это поле обычно пишем что-то более осмысленное, характеризующее именно наш товар. Более того, мы хотим, чтобы во всех товарах, содержащих это Значение,
                    оно было бы одинаковым и по этому Значению можно было бы найти наши товары, например, с помощью фильтра.

С точки зрения разработчиков Opencart, конструкция <mark><small>Товар->Атрибут->Значение</small></mark> является достаточной, но на практике этого маловато. Часто встречается
                    конструкция <mark><small>Товар->Атрибут->Набор Значений</small></mark>.

Например, я продаю модули для Opencart и хочу показать, некоторые из нх совместимы с версиями `1.5.x`, `2.0.1`, `2.1.x`, а другие еще и с версиями
                    `2.3.x`, `3.0.x`. Я так и напишу в Значения Атрибута `&#x421;&#x43E;&#x432;&#x43C;&#x435;&#x441;&#x442;&#x438;&#x43C;&#x43E;&#x441;&#x442;&#x44C;` соответствующих товаров,
                    перечислив версии через разделитель - запятую или, допустим, слэш. `v1.5.x/2.0.1/2.1.x` и `v1.5.x/2.0.1/2.1.x/2.3.x/3.0.x`

Opencart никак не отработает такую конструкцию, просто выведет ее целиком в карточке товара. Но умные люди придумали умные фильтры, чтоб расширить возможности структуризации товаров
                    и их поиска по Значениям.

Ниже показано, как обрабатывает Opencart, Attribut&co, filterpro такие наборы Значений. Я их назвал Шаблоны. Не нравится это название?
                    Зайдите в языковый файл и поставьте свое - "Наборы", "Списки" и т.д. Главное понимание, что это такое.

Итак Шаблон это набор Значений Атрибута, записанных через разделитель. Иногда его называют "Множественным значением".

Разделитель атрибутов или Разделитель значений атрибутов придумал не я. Вот как он выглядит в настройках популярных фильтров
                    Mega Filter Pro и filterpro

Необходимо отметить, что Значение уникально для каждого товара. Если в каком-то товаре изменить одну букву в тексте, то остальных товаров это не коснется,
                    даже если до этого Значения совпадали, а у вас появится еще одно Значение. То же самое верно и для Шаблонов.

## Дежурный шаблон - значение по умолчанию.

Естественным желанием является то, чтобы при добавлении Атрибута в товар, синхронно добавлялось Значение или
                    набор Значений. Особенно если Значения одни и те же, а операций надо выполнить много.

Эти Значения должны где-то храниться. Для этого и служит Дежурный Шаблон. Именно там храняться Значения,
                    которые будут по умолчанию подставляться в товар, как только вы добавите туда Атрибут.

Для того чтобы подстановка состоялась, надо не забывать про [настройки](settings.html#settings-product).

Дежурный Шаблон можно изменять многократно для подстановки других Значений в другие товары не затрагивая уже имеющиеся.
                    Для этого надо использовать настройку `&#x41F;&#x43E;&#x434;&#x441;&#x442;&#x430;&#x432;&#x43B;&#x44F;&#x442;&#x44C; &#x434;&#x435;&#x436;&#x443;&#x440;&#x43D;&#x44B;&#x439; &#x442;&#x43E;&#x43B;&#x44C;&#x43A;&#x43E; &#x432; &#x43F;&#x443;&#x441;&#x442;&#x44B;&#x435;`.

Дежурный Шаблон можно [удалять](using.html#using-duty-del).

## Принцип фильтрации товаров.

#### Режим совпадений.

|  Выбрано |  Соответствие товаров |
| --- | --- |
|  Атрибут |  Все товары, где есть данныйАтрибут. Выборка происходит по id, а не по наименованию, поэтому, если в другойГруппе будетАтрибут с таким же наименованием, товары, ему соответствующие, в выборку не попадут. |
|  Шаблон |  Все товары, где есть родительскийАтрибут и поле, содержащее характеристики товара точно совпадает с выбраннымШаблоном. |
|  Значение |  Все товары, где есть родительскийАтрибут и поле характеристик товара содержит выбранноеЗначение. |

#### Режим расхождений.

|  Выбрано |  Соответствие товаров |
| --- | --- |
|  Атрибут |  Все товары, где нет данногоАтрибута. |
|  Шаблон |  Все товары, где есть родительскийАтрибут и поле, содержащее характеристики товара точно не совпадает с выбраннымШаблоном. |
|  Значение |  Все товары, где есть родительскийАтрибут и поле характеристик товара не содержит выбранноеЗначение. |

В режиме расхождений иконки папок в дереве товаров меняют цвет.

## Загрузка узлов.

Медленная загрузка деревьев может свести на нет все усилия по облегчению работы с атрибутами. Поэтому, для дочерних узлов, таких как Шаблоны и Значения
                    используется, так называемая, ленивая (lazy) загрузка. Эти узлы не загружаются в момент загрузки дерева, а подгружаются по мере обращения к ним, т.е. по запросу. Вот почему при двойном клике на узел
                    Шаблоны или Значения прежде, чем откроется этот узел, приходится наблюдать индикатор загрузки ![loading](/img/loading_ajax.gif).

Такая загрузка узлов дает существеный выигрыш при загрузке деревьев и их перезагрузки во время синхронизации, но накладывает особенности на работу фильтра. Т.к. при выполнении
                    поиска фильтру приходится делать обход всего дерева и принудительно открывать все узлы, то поиск, во-первых, происходит медленно, во-вторых, некорректно работает счетчик найденных совпадений.
                    Однако если запустить поиск повторно, то все происходит быстро и считается правильно, т.к. все узлы уже открыты.

Для открытия узлов используются ajax-запросы, каждый из которых вносит задержку до 1 секунды. Испытания на большом количестве атрибутов показали, что часто происходит зависание.

Начиная с версии 2.1.4 появилась возможность управлять режимом загрузки. Либо в настройках, либо через [контекстное меню](using.html#using-context-menu), можно включить или отключить режим ленивой загрузки. Если этот
                    режим отключен, все узлы дерева загружаются полностью. Отпадает необходимость делать обход дерева и догружать узлы, что многократно ускоряет поиск.

Таким образом, если предполагается активное использование поиска, то лучше перезагрузить деревья, отключив ленивую загрузку.

Поскольку загрузка узлов производится с помощью асинхронных ajax запросов, иногда в консоли можно увидеть сообщения типа:
<small>FancytreeNode(#attribute_393, 'New attribute') scrollIntoView(): node is invisible</small>

Это означает, что данные ajax запроса не успели загрузиться до начала их использования. Особенно это проявляется на медленных серверах. Ничего страшного,
                     на результаты работы модуля это не влияет.

## Мультиязычность и синхронизация.

Поскольку модуль является мультиязычным, то для каждого языка будут создаваться свои деревья. Для удобства к обозначениям деревьев будем прибавлять языковую приставку .ru
                    или .en там, где это необходимо для объяснения. Для сохраниния целостности БД применяется синхронизация между деревьями. Например, при добавлении нового Атрибута в
                    Группы атрибутов.ru, в дерево Группы атрибутов.en синхронно добавится новый Атрибут с названием "New attribute".
                    То же самое касается Групп атрибутов. А вот Шаблоны, Значения и Дежурные шаблоны синхронно не добавляются.

Синхронизация происходит так же при редактировании Групп, Атрибутов, Шаблонов, Значений.
                    Во всех деревьях, где присутствует изменяемый Узел, изменения происходят синхронно и в соответсвии с выбранным языком.

* [Немного теории](#theory-theory)
* [Термины и определения](#theory-terms)
* [Шаблоны и значения](#theory-template)
* [Дежурный шаблон](#theory-duty)
* [Фильтрация товаров](#theory-product)
* [Загрузка узлов](#theory-loading)
* [Синхронизация](#theory-synchro)
